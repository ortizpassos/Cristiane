<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Simulação Plataforma de Professoras — Single File</title>

  <!-- Icons & Chart.js -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --primary:#3f51b5;
      --primary-dark:#303f9f;
      --bg:#f5f7fb;
      --card:#fff;
      --muted:#667085;
      --success:#4caf50;
      --danger:#e53935;
      font-family: Inter, Roboto, Arial, sans-serif;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:#222;}
    .app {
      display:flex;
      min-height:100vh;
      gap:16px;
    }

    /* SIDEBAR */
    .sidebar{
      width:260px;
      background:linear-gradient(180deg,var(--primary),var(--primary-dark));
      color:white;
      padding:18px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .brand{font-weight:700;font-size:1.1rem;display:flex;align-items:center;gap:10px}
    .brand .material-icons{background:rgba(255,255,255,0.12);padding:6px;border-radius:8px}
    .nav{margin-top:6px;display:flex;flex-direction:column;gap:6px}
    .nav a{
      color:white;text-decoration:none;padding:10px;border-radius:8px;display:flex;align-items:center;gap:12px;
    }
    .nav a:hover{background:rgba(255,255,255,0.06)}
    .nav a.active{background:rgba(0,0,0,0.12)}
    .sidebar .meta{margin-top:auto;font-size:0.85rem;color:rgba(255,255,255,0.9)}
    .sidebar .meta small{display:block;color:rgba(255,255,255,0.75);margin-top:6px}

    /* CONTENT */
    .content{
      flex:1;padding:18px 24px;
    }
    header.top{
      display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:18px;
    }
    header .title{font-size:1.2rem;font-weight:600}
    .search-inline{display:flex;gap:8px;align-items:center}
    .search-inline input{padding:8px 10px;border-radius:8px;border:1px solid #dfe7f3;min-width:220px}
    .btn{background:var(--primary);color:white;border:none;padding:8px 12px;border-radius:8px;cursor:pointer}
    .card{background:var(--card);padding:14px;border-radius:12px;box-shadow:0 3px 10px rgba(15,23,42,0.06);}

    /* DASHBOARD CARDS */
    .cards{display:flex;gap:12px;margin-bottom:16px;flex-wrap:wrap}
    .card.small{flex:1;min-width:160px}
    .card.large{flex:2;min-width:300px}

    /* responsive grid for main content */
    .grid-2{display:grid;grid-template-columns:1fr 420px;gap:12px}
    .grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}

    /* table */
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid #eef2f6;text-align:left}
    th{font-size:0.85rem;color:var(--muted)}
    .chip{display:inline-block;padding:6px 10px;border-radius:999px;font-size:0.85rem}
    .chip.success{background:rgba(76,175,80,0.12);color:var(--success)}
    .chip.warn{background:rgba(255,193,7,0.12);color:#ffb300}
    .chip.danger{background:rgba(229,57,53,0.08);color:var(--danger)}

    /* teacher card */
    .teacher-list{display:flex;flex-direction:column;gap:10px}
    .teacher-item{display:flex;gap:12px;align-items:center;padding:10px;border-radius:10px;background:var(--card)}
    .teacher-item img{width:64px;height:64px;border-radius:8px;object-fit:cover}
    .teacher-item .meta{flex:1}
    .teacher-item h4{margin:0;margin-bottom:4px}
    .teacher-item p{margin:0;color:var(--muted);font-size:0.95rem}

    /* small UI */
    .muted{color:var(--muted);font-size:0.95rem}
    .mb{margin-bottom:12px}
    .space{height:12px}
    .settings-row{display:flex;gap:12px;align-items:center;margin-bottom:8px}

    /* footer small */
    footer.small{margin-top:18px;font-size:0.85rem;color:var(--muted)}
    @media(max-width:900px){
      .sidebar{display:none}
      .app{flex-direction:column}
      .grid-2{grid-template-columns:1fr}
      .grid-3{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <div class="app">
    <aside class="sidebar" aria-label="menu">
      <div class="brand">
        <span class="material-icons">child_care</span>
        Plataforma Professora
      </div>

      <nav class="nav" id="main-nav">
        <a href="#/dashboard" data-route="/dashboard"><span class="material-icons">dashboard</span> Dashboard</a>
        <a href="#/teachers" data-route="/teachers"><span class="material-icons">school</span> Professoras</a>
        <a href="#/bookings" data-route="/bookings"><span class="material-icons">event</span> Agendamentos</a>
        <a href="#/reports" data-route="/reports"><span class="material-icons">insert_chart</span> Relatórios</a>
        <a href="#/users" data-route="/users"><span class="material-icons">people</span> Usuários</a>
        <a href="#/settings" data-route="/settings"><span class="material-icons">settings</span> Configurações</a>
      </nav>

      <div class="meta">
        <div>Simulação • versão local</div>
        <small>Dados mock — sem autenticação</small>
      </div>
    </aside>

    <main class="content">
      <header class="top">
        <div class="title">Simulação: Plataforma</div>
        <div class="search-inline">
          <input id="globalSearch" placeholder="Pesquisar professoras, pais, serviços..." />
          <button class="btn" id="btnQuickSearch">Pesquisar</button>
        </div>
      </header>

      <!-- VIEWS -->
      <section id="view-dashboard" style="display:none;">
        <div class="cards">
          <div class="card small">
            <div class="muted">Total de Usuários</div>
            <h2 id="stat-users">0</h2>
            <div class="muted">Última atualização: <span id="stat-usertime">--</span></div>
          </div>
          <div class="card small">
            <div class="muted">Total de Professoras</div>
            <h2 id="stat-teachers">0</h2>
            <div class="muted">Ativas / Verificadas</div>
          </div>
          <div class="card small">
            <div class="muted">Agendamentos Totais</div>
            <h2 id="stat-bookings">0</h2>
            <div class="muted">Este mês</div>
          </div>
          <div class="card large">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div><strong>Gráfico de agendamentos (30 dias)</strong><div class="muted">Dados simulados</div></div>
              <div><button class="btn" onclick="randomizeData()">Atualizar</button></div>
            </div>
            <canvas id="chartBookings" style="margin-top:12px;"></canvas>
          </div>
        </div>

        <div class="grid-2">
          <div>
            <div class="card mb">
              <h3>Atividade Recente</h3>
              <ul id="recentActivity" style="list-style:none;padding:0;margin:0"></ul>
            </div>

            <div class="card mb">
              <h3>Top Professoras</h3>
              <div id="topTeachers"></div>
            </div>
          </div>

          <div>
            <div class="card mb">
              <h3>Resumo Financeiro (simulado)</h3>
              <p class="muted">Receita total, taxa da plataforma e repasses</p>
              <div style="display:flex;gap:10px;margin-top:12px">
                <div style="flex:1">
                  <div class="muted">Receita</div>
                  <h3 id="stat-revenue">R$ 0,00</h3>
                </div>
                <div style="flex:1">
                  <div class="muted">Taxas (10%)</div>
                  <h3 id="stat-fees">R$ 0,00</h3>
                </div>
              </div>
            </div>

            <div class="card mb">
              <h3>Disponibilidade Hoje</h3>
              <div id="availabilityList"></div>
            </div>
          </div>
        </div>
      </section>

      <section id="view-teachers" style="display:none;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
          <h2>Professoras</h2>
          <div style="display:flex;gap:8px">
            <select id="filterAge"><option value="">Todas as idades</option><option value="2-4">2-4</option><option value="4-6">4-6</option><option value="6-12">6-12</option></select>
            <input id="filterService" placeholder="Serviço (ex: Alfabetização)" />
            <button class="btn" onclick="renderTeachers()">Aplicar</button>
          </div>
        </div>

        <div id="teacher-list" class="teacher-list"></div>
      </section>

      <section id="view-bookings" style="display:none;">
        <h2>Agendamentos</h2>
        <div class="card mb">
          <table id="tableBookings">
            <thead><tr><th>ID</th><th>Pais</th><th>Professora</th><th>Serviço</th><th>Data/Hora</th><th>Status</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

      <section id="view-reports" style="display:none;">
        <h2>Relatórios</h2>
        <div class="card mb">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <strong>Relatório de serviços</strong>
              <div class="muted">Filtro por serviço / período (simulado)</div>
            </div>
            <div>
              <button class="btn" onclick="exportCSV()">Exportar CSV</button>
            </div>
          </div>

          <div style="margin-top:12px">
            <table id="reportTable">
              <thead><tr><th>Serviço</th><th>QTD</th><th>Receita</th><th>Taxa</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </section>

      <section id="view-users" style="display:none;">
        <h2>Usuários</h2>
        <div class="card mb">
          <table id="usersTable">
            <thead><tr><th>Nome</th><th>Email</th><th>Tipo</th><th>Status</th><th>Ações</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

      <section id="view-settings" style="display:none;">
        <h2>Configurações</h2>
        <div class="card">
          <div class="settings-row">
            <label>Taxa da plataforma (%)</label>
            <input id="cfgFee" type="number" step="0.1" min="0" value="10" style="width:100px;padding:8px;border-radius:8px;border:1px solid #e6eef8" />
            <button class="btn" onclick="saveSettings()">Salvar</button>
          </div>

          <div class="settings-row">
            <label>Intervalo de atualização (seg)</label>
            <input id="cfgInterval" type="number" min="5" value="20" style="width:100px;padding:8px;border-radius:8px;border:1px solid #e6eef8" />
            <div class="muted">Somente simulado — altera velocidade de auto-refresh</div>
          </div>

          <div style="margin-top:12px">
            <button class="btn" onclick="resetData()">Resetar Dados Simulados</button>
          </div>
          <footer class="small">Configurações salvas localmente no navegador (localStorage)</footer>
        </div>
      </section>

      <div class="space"></div>
      <footer class="small">Simulação gerada localmente • Não envia dados a servidores</footer>
    </main>
  </div>

  <script>
    /***********************
     * MOCK DATA GENERATION
     ***********************/
    const MOCK = {
      users: [],
      teachers: [],
      bookings: [],
      services: [
        { id:1, name:'Cuidados Gerais' },
        { id:2, name:'Alfabetização - Infantil' },
        { id:3, name:'Acompanhamento Escolar' }
      ]
    };

    // utils
    const rand = (min,max) => Math.floor(Math.random()*(max-min+1))+min;
    const money = n => 'R$ ' + n.toLocaleString('pt-BR', {minimumFractionDigits:2, maximumFractionDigits:2});

    function seedMockData() {
      // users (parents + admins)
      MOCK.users = [
        { id:1, name:'Eduardo', email:'eduardo@exemplo.com', type:'PARENT', active:true },
        { id:2, name:'Mariana Lopes', email:'mariana@ex.com', type:'TEACHER', active:true },
        { id:3, name:'João Silva', email:'joao@ex.com', type:'PARENT', active:true },
        { id:4, name:'Admin Local', email:'admin@ex.com', type:'ADMIN', active:true }
      ];

      // teachers
      const tpls = [
        { name:'Mariana Souza', bio:'Especialista em alfabetização infantil com 8 anos.', ageRange:'4-8', rating:4.8, img:'https://i.pravatar.cc/150?img=5' },
        { name:'Ana Clara', bio:'Professora de reforço e acompanhamento pedagógico.', ageRange:'6-12', rating:4.6, img:'https://i.pravatar.cc/150?img=9' },
        { name:'Patrícia Lima', bio:'Cuidadora e educadora infantil (formada em pedagogia).', ageRange:'2-6', rating:4.9, img:'https://i.pravatar.cc/150?img=10' },
        { name:'Joana Almeida', bio:'Atividades lúdicas e alfabetização inicial.', ageRange:'3-7', rating:4.7, img:'https://i.pravatar.cc/150?img=20' },
        { name:'Beatriz Santos', bio:'Auxílio escolar e reforço em matemática.', ageRange:'7-12', rating:4.5, img:'https://i.pravatar.cc/150?img=16' }
      ];
      MOCK.teachers = tpls.map((t,i) => ({
        id:100+i,
        name:t.name,
        bio:t.bio,
        ageRange:t.ageRange,
        rating:t.rating,
        img:t.img,
        services: [MOCK.services[rand(0,2)].name],
        verified: Math.random() > 0.2,
        hourly: (rand(20,80) + rand(0,99)/100).toFixed(2),
        availability: generateAvailability()
      }));
      // bookings
      MOCK.bookings = [];
      const parents = MOCK.users.filter(u=>u.type==='PARENT');
      for(let i=0;i<30;i++){
        const teacher = MOCK.teachers[rand(0,MOCK.teachers.length-1)];
        const parent = parents[rand(0,parents.length-1)];
        const serv = MOCK.services[rand(0,MOCK.services.length-1)];
        const d = new Date();
        d.setDate(d.getDate() - rand(0,20) + rand(0,20));
        d.setHours(rand(8,18), [0,15,30,45][rand(0,3)]);
        const price = parseFloat(teacher.hourly) + rand(0,40);
        MOCK.bookings.push({
          id: 500 + i,
          parent: parent.name,
          teacher: teacher.name,
          service: serv.name,
          datetime: d.toISOString(),
          status: ['REQUESTED','CONFIRMED','COMPLETED','CANCELLED'][rand(0,3)],
          price: price
        });
      }
    }

    function generateAvailability() {
      // simple weekly availability mock
      const days = ['Seg','Ter','Qua','Qui','Sex','Sáb'];
      return days.map(d => ({ day:d, slots: rand(2,5) }));
    }

    /***********************
     * APP STATE & SETTINGS
     ***********************/
    const Settings = {
      feePercent: parseFloat(localStorage.getItem('cfg_fee') || '10'),
      updateInterval: parseInt(localStorage.getItem('cfg_interval') || '20')
    };

    function saveSettingsToLocal() {
      localStorage.setItem('cfg_fee', String(Settings.feePercent));
      localStorage.setItem('cfg_interval', String(Settings.updateInterval));
    }

    /***********************
     * RENDERERS
     ***********************/
    // navbar active
    function setActiveNav(route) {
      document.querySelectorAll('.nav a').forEach(a => {
        a.classList.toggle('active', a.dataset.route === route);
      });
    }

    function formatDateIso(iso) {
      const d = new Date(iso);
      return d.toLocaleString('pt-BR');
    }

    // Dashboard render
    let chartBookings = null;
    function renderDashboard() {
      showView('view-dashboard');
      document.getElementById('stat-users').innerText = MOCK.users.length;
      document.getElementById('stat-teachers').innerText = MOCK.teachers.length;
      document.getElementById('stat-bookings').innerText = MOCK.bookings.length;
      document.getElementById('stat-usertime').innerText = new Date().toLocaleTimeString();

      // revenue & fees
      const revenue = MOCK.bookings.reduce((s,b)=>s + (b.price||0), 0);
      const fees = revenue * (Settings.feePercent/100);
      document.getElementById('stat-revenue').innerText = money(revenue);
      document.getElementById('stat-fees').innerText = money(fees);

      // recent activity
      const act = MOCK.bookings.slice(-8).reverse();
      const ul = document.getElementById('recentActivity');
      ul.innerHTML = act.map(a => `<li class="mb card" style="padding:8px"><strong>${a.teacher}</strong> - ${a.service} • <span class="muted">${formatDateIso(a.datetime)}</span></li>`).join('');

      // top teachers
      const top = MOCK.teachers.slice(0,5);
      const topDiv = document.getElementById('topTeachers');
      topDiv.innerHTML = top.map(t => `<div style="padding:8px;display:flex;align-items:center;gap:8px;border-bottom:1px solid #f1f6fb"><img src="${t.img}" width="42" height="42" style="border-radius:6px" /><div><strong>${t.name}</strong><div class="muted">${t.services.join(', ')} • ${t.ageRange} anos</div></div></div>`).join('');

      // availability list
      const avail = document.getElementById('availabilityList');
      avail.innerHTML = MOCK.teachers.slice(0,5).map(t=>`<div style="padding:8px;border-bottom:1px solid #f1f6fb"><strong>${t.name}</strong><div class="muted">${t.availability.map(a=>a.day + ' ('+a.slots+' slots)').join(' • ')}</div></div>`).join('');

      // chart data: bookings per day last 30 days
      const labels = [];
      const data = [];
      for(let i=29;i>=0;i--){
        const d = new Date();
        d.setDate(d.getDate()-i);
        const label = `${d.getDate()}/${d.getMonth()+1}`;
        labels.push(label);
        // randomize based on bookings distribution
        const count = MOCK.bookings.filter(b => {
          const bd = new Date(b.datetime);
          return bd.getDate()===d.getDate() && bd.getMonth()===d.getMonth() && bd.getFullYear()===d.getFullYear();
        }).length;
        data.push(count + rand(0,3));
      }

      const ctx = document.getElementById('chartBookings').getContext('2d');
      if(chartBookings) chartBookings.destroy();
      chartBookings = new Chart(ctx, {
        type:'line',
        data:{
          labels,
          datasets:[{
            label:'Agendamentos',
            data,
            tension:0.3,
            fill:true,
            backgroundColor:'rgba(63,81,181,0.12)',
            borderColor:'rgba(63,81,181,0.9)',
            pointRadius:2
          }]
        },
        options:{
          plugins:{legend:{display:false}},
          scales:{
            x:{grid:{display:false}},
            y:{beginAtZero:true, ticks:{precision:0}}
          }
        }
      });
    }

    // Teachers list render
    function renderTeachers() {
      showView('view-teachers');
      const list = document.getElementById('teacher-list');
      const ageFilter = document.getElementById('filterAge').value;
      const serviceFilter = document.getElementById('filterService').value.toLowerCase();

      const filtered = MOCK.teachers.filter(t => {
        let ok = true;
        if(ageFilter) {
          ok = ok && (t.ageRange.replace(/\s/g,'') === ageFilter);
        }
        if(serviceFilter) {
          ok = ok && (t.services.join(' ').toLowerCase().includes(serviceFilter) || t.name.toLowerCase().includes(serviceFilter));
        }
        return ok;
      });

      list.innerHTML = filtered.map(t => `
        <div class="teacher-item card" onclick="openTeacher(${t.id})">
          <img src="${t.img}" alt="${t.name}" />
          <div class="meta">
            <h4>${t.name} <span style="font-size:0.9rem;color:var(--muted)">• ${t.ageRange} anos</span></h4>
            <p>${t.bio}</p>
            <div style="margin-top:8px">
              <span class="chip ${t.verified ? 'success' : 'warn'}">${t.verified ? 'Verificada' : 'Pendente'}</span>
              <span style="margin-left:8px" class="muted">Avaliação: ${t.rating} ⭐</span>
            </div>
          </div>
          <div style="text-align:right">
            <div class="muted">R$ ${Number(t.hourly).toFixed(2)}/h</div>
            <button class="btn" style="margin-top:8px" onclick="event.stopPropagation(); bookNow(${t.id})">Agendar</button>
          </div>
        </div>
      `).join('');
    }

    // Bookings render
    function renderBookings() {
      showView('view-bookings');
      const tbody = document.querySelector('#tableBookings tbody');
      tbody.innerHTML = MOCK.bookings.map(b => `
        <tr>
          <td>${b.id}</td>
          <td>${b.parent}</td>
          <td>${b.teacher}</td>
          <td>${b.service}</td>
          <td>${formatDateIso(b.datetime)}</td>
          <td><span class="chip ${b.status==='COMPLETED'?'success':b.status==='CANCELLED'?'danger':'warn'}">${b.status}</span></td>
        </tr>
      `).join('');
    }

    // Reports render
    function renderReports() {
      showView('view-reports');
      const map = {};
      MOCK.bookings.forEach(b => {
        if(!map[b.service]) map[b.service] = {q:0, revenue:0};
        map[b.service].q++;
        map[b.service].revenue += b.price || 0;
      });
      const tbody = document.querySelector('#reportTable tbody');
      tbody.innerHTML = Object.keys(map).map(k => {
        const entry = map[k];
        const fee = entry.revenue * (Settings.feePercent/100);
        return `<tr><td>${k}</td><td>${entry.q}</td><td>${money(entry.revenue)}</td><td>${money(fee)}</td></tr>`;
      }).join('');
    }

    // Users render
    function renderUsers() {
      showView('view-users');
      const tbody = document.querySelector('#usersTable tbody');
      tbody.innerHTML = MOCK.users.map(u => `
        <tr>
          <td>${u.name}</td>
          <td>${u.email}</td>
          <td>${u.type}</td>
          <td>${u.active ? '<span class="chip success">Ativo</span>' : '<span class="chip danger">Inativo</span>'}</td>
          <td><button class="btn" onclick="editUser(${u.id})">Editar</button></td>
        </tr>
      `).join('');
    }

    /***********************
     * INTERACTIONS
     ***********************/
    function showView(id) {
      document.querySelectorAll('main section').forEach(s => s.style.display = 'none');
      const el = document.getElementById(id);
      if (el) el.style.display = 'block';
      // set active nav
      const routeMap = {
        'view-dashboard':'/dashboard',
        'view-teachers':'/teachers',
        'view-bookings':'/bookings',
        'view-reports':'/reports',
        'view-users':'/users',
        'view-settings':'/settings'
      };
      setActiveNav(routeMap[id] || '/dashboard');
    }

    function openTeacher(id) {
      const t = MOCK.teachers.find(x=>x.id===id);
      if(!t) return alert('Professora não encontrada');
      // modal-like quick view
      const html = `
        <div style="max-width:700px">
          <div style="display:flex;gap:12px">
            <img src="${t.img}" width="120" height="120" style="border-radius:12px" />
            <div>
              <h3 style="margin:0">${t.name}</h3>
              <div class="muted">${t.services.join(', ')} • ${t.ageRange} anos</div>
              <p style="margin-top:12px">${t.bio}</p>
              <div style="margin-top:8px"><strong>Horário:</strong> ${t.availability.map(a=>a.day+': '+a.slots+' slots').join(' • ')}</div>
              <div style="margin-top:8px"><strong>Valor/h:</strong> R$ ${Number(t.hourly).toFixed(2)}</div>
              <div style="margin-top:12px">
                <button class="btn" onclick="bookNow(${t.id})">Agendar</button>
                <button style="margin-left:8px;padding:8px;border-radius:8px;border:1px solid #e6eef8;background:white;cursor:pointer" onclick="closeDialog()">Fechar</button>
              </div>
            </div>
          </div>
        </div>
      `;
      showDialog('Perfil da Professora', html);
    }

    // booking simulation
    function bookNow(teacherId) {
      closeDialog();
      const t = MOCK.teachers.find(x=>x.id===teacherId);
      const parent = MOCK.users.find(u=>u.type==='PARENT') || {name:'Pai Simulado'};
      const dt = new Date(); dt.setDate(dt.getDate()+rand(1,7)); dt.setHours(rand(9,17), 0, 0, 0);
      const price = parseFloat(t.hourly) + rand(0,40);
      const booking = {
        id: 900 + MOCK.bookings.length + 1,
        parent: parent.name,
        teacher: t.name,
        service: t.services[0] || MOCK.services[0].name,
        datetime: dt.toISOString(),
        status: 'REQUESTED',
        price
      };
      MOCK.bookings.push(booking);
      alert('Agendamento solicitado (simulado) para ' + t.name + ' em ' + dt.toLocaleString());
      renderBookings();
      renderDashboard();
    }

    /* Dialog utilities */
    let dialogElm = null;
    function showDialog(title, html) {
      if(dialogElm) closeDialog();
      dialogElm = document.createElement('div');
      dialogElm.style.position='fixed';
      dialogElm.style.left='0'; dialogElm.style.top='0'; dialogElm.style.right='0'; dialogElm.style.bottom='0';
      dialogElm.style.background='rgba(2,6,23,0.4)';
      dialogElm.style.display='flex'; dialogElm.style.alignItems='center'; dialogElm.style.justifyContent='center'; dialogElm.style.zIndex=9999;
      const box = document.createElement('div');
      box.className='card';
      box.style.maxWidth='820px';
      box.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><h3>${title}</h3><button onclick="closeDialog()" style="background:#efefef;border:none;padding:6px;border-radius:8px">Fechar</button></div><div style="margin-top:12px">${html}</div>`;
      dialogElm.appendChild(box);
      document.body.appendChild(dialogElm);
    }
    function closeDialog(){ if(dialogElm){ dialogElm.remove(); dialogElm=null; } }

    // quick edit user
    function editUser(id) {
      const u = MOCK.users.find(x=>x.id===id);
      if(!u) return;
      const html = `<div style="display:flex;flex-direction:column;gap:8px">
        <label>Nome <input id="dlg_name" value="${u.name}" style="width:100%;padding:8px;border-radius:8px;border:1px solid #e6eef8" /></label>
        <label>Email <input id="dlg_email" value="${u.email}" style="width:100%;padding:8px;border-radius:8px;border:1px solid #e6eef8" /></label>
        <label>Ativo <select id="dlg_active"><option value="1" ${u.active?'selected':''}>Sim</option><option value="0" ${!u.active?'selected':''}>Não</option></select></label>
        <div style="display:flex;gap:8px">
          <button class="btn" onclick="saveUser(${u.id})">Salvar</button>
          <button onclick="closeDialog()" style="padding:8px;border-radius:8px;border:1px solid #e6eef8;background:white">Cancelar</button>
        </div>
      </div>`;
      showDialog('Editar Usuário', html);
    }
    function saveUser(id) {
      const u = MOCK.users.find(x=>x.id===id);
      if(!u) return;
      u.name = document.getElementById('dlg_name').value;
      u.email = document.getElementById('dlg_email').value;
      u.active = document.getElementById('dlg_active').value === '1';
      closeDialog();
      renderUsers();
    }

    // export CSV from report table
    function exportCSV() {
      const rows = [['Serviço','QTD','Receita','Taxa']];
      MOCK.bookings.reduce((map,b)=>{
        if(!map[b.service]) map[b.service]={q:0,revenue:0};
        map[b.service].q++; map[b.service].revenue += b.price||0; return map;
      }, {});
      const map = {};
      MOCK.bookings.forEach(b => {
        if(!map[b.service]) map[b.service]={q:0,revenue:0};
        map[b.service].q++; map[b.service].revenue+=b.price||0;
      });
      Object.keys(map).forEach(k => rows.push([k,map[k].q, map[k].revenue.toFixed(2), (map[k].revenue*(Settings.feePercent/100)).toFixed(2)]));
      const csv = rows.map(r => r.map(c => `"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'report.csv'; a.click();
      URL.revokeObjectURL(url);
    }

    // search
    document.getElementById('btnQuickSearch').addEventListener('click', ()=> {
      const q = document.getElementById('globalSearch').value.toLowerCase().trim();
      if(!q) return alert('Digite algo para pesquisar');
      // route to teachers and apply filter
      location.hash = '#/teachers';
      setTimeout(()=> {
        document.getElementById('filterService').value = q;
        renderTeachers();
      }, 100);
    });

    // routing
    function route() {
      const hash = location.hash || '#/dashboard';
      const route = hash.replace('#','').split('?')[0];
      switch(route) {
        case '/dashboard': renderDashboard(); break;
        case '/teachers': renderTeachers(); break;
        case '/bookings': renderBookings(); break;
        case '/reports': renderReports(); break;
        case '/users': renderUsers(); break;
        case '/settings': showView('view-settings'); break;
        default: renderDashboard(); break;
      }
    }
    window.addEventListener('hashchange', route);

    // settings
    function saveSettings(){
      const fee = parseFloat(document.getElementById('cfgFee').value || '10');
      const interval = parseInt(document.getElementById('cfgInterval').value || '20');
      Settings.feePercent = fee;
      Settings.updateInterval = interval;
      saveSettingsToLocal();
      alert('Configurações salvas (simulado)');
      renderReports();
      renderDashboard();
    }

    function resetData() {
      seedMockData();
      saveSettingsToLocal();
      renderDashboard();
      renderTeachers();
      renderBookings();
      alert('Dados simulados resetados');
    }

    // exportable small helpers
    function randomizeData() {
      // add some bookings random
      for(let i=0;i<5;i++){
        const t = MOCK.teachers[rand(0,MOCK.teachers.length-1)];
        const parent = MOCK.users.find(u=>u.type==='PARENT') || {name:'Pai Simulado'};
        const d = new Date(); d.setDate(d.getDate()+rand(-3,3)); d.setHours(rand(8,18),0,0,0);
        MOCK.bookings.push({ id: 700 + MOCK.bookings.length + 1, parent: parent.name, teacher: t.name, service: t.services[0], datetime: d.toISOString(), status: ['CONFIRMED','COMPLETED'][rand(0,1)], price: parseFloat(t.hourly) + rand(0,40) });
      }
      renderDashboard();
      renderBookings();
    }

    // Dialog close on ESC
    window.addEventListener('keydown', e => { if(e.key==='Escape') closeDialog(); });

    // export functionalities
    function exportState() {
      const state = { MOCK, Settings };
      const blob = new Blob([JSON.stringify(state)], {type:'application/json'});
      const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='sim_state.json'; a.click(); URL.revokeObjectURL(url);
    }

    // initial boot
    (function init(){
      seedMockData();
      // apply stored settings
      document.getElementById('cfgFee').value = Settings.feePercent;
      document.getElementById('cfgInterval').value = Settings.updateInterval;

      // initial route
      if(!location.hash) location.hash = '#/dashboard';
      route();

      // auto-refresh (simulated)
      setInterval(()=>{
        // occasionally add activity
        if(Math.random() > 0.6) randomizeData();
      }, Math.max(5000, Settings.updateInterval * 1000));
    })();
  </script>
</body>
</html>
