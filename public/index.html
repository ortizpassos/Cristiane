<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Simulação Plataforma — Admin / Professor / Pais</title>

  <!-- Icons & Chart.js -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#ff4081">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <style>
    :root{
      /* Palette: degradê entre rosa e azul claro */
      --primary:#ff4081; /* rosa */
      --primary-dark:#81d4fa; /* azul claro */
      --primary-contrast:#fff;
      --bg: linear-gradient(90deg,#ffd6e7,#e3f2fd); /* fundo degradê rosa -> azul claro */
      --card:#fff;
      --muted:#667085;
      --success:#4caf50;
      --danger:#e53935;
      font-family: Inter, Roboto, Arial, sans-serif;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:#222;}
    .app { display:flex; min-height:100vh; gap:16px; }

    /* HOME selector */
    .home-chooser{
      display:flex;
      align-items:center;
      justify-content:center;
      height:calc(100vh - 56px); /* desconta navbar */
      background:linear-gradient(180deg,#eef3ff,#f5f7fb);
      padding:24px;
    }
    .chooser-card{
      background:var(--card);
      padding:28px;
      border-radius:12px;
      box-shadow:0 6px 20px rgba(15,23,42,0.08);
      max-width:920px;
      width:100%;
      margin:auto;
      display:flex;
      flex-direction:column;
      align-items:center;
    }
    .chooser-grid{display:flex;gap:12px;flex-wrap:wrap}
    .role-card{flex:1;min-width:200px;padding:18px;border-radius:10px;border:1px solid #eef2f6;background:linear-gradient(180deg,#ffffff,#fbfdff);cursor:pointer;transition:transform .15s,box-shadow .15s}
    .role-card:hover{transform:translateY(-4px);box-shadow:0 8px 30px rgba(15,23,42,0.06)}
    .role-card h3{margin:6px 0;font-size:1.1rem;color:var(--primary)}
    .role-card p{margin:0;color:var(--muted)}

    /* SIDEBAR */
  .sidebar{width:260px;background:linear-gradient(180deg,var(--primary),var(--primary-dark));color:white;padding:18px;display:flex;flex-direction:column;gap:12px}
    .brand{font-weight:700;font-size:1.1rem;display:flex;align-items:center;gap:10px}
    .brand .material-icons{background:rgba(255,255,255,0.12);padding:6px;border-radius:8px}
    .nav{margin-top:6px;display:flex;flex-direction:column;gap:6px}
    .nav a{color:white;text-decoration:none;padding:10px;border-radius:8px;display:flex;align-items:center;gap:12px}
    .nav a:hover{background:rgba(255,255,255,0.06)}
    .nav a.active{background:rgba(0,0,0,0.12)}
    .sidebar .meta{margin-top:auto;font-size:0.85rem;color:rgba(255,255,255,0.9)}
    .sidebar .meta small{display:block;color:rgba(255,255,255,0.75);margin-top:6px}

    /* CONTENT */
    .content{flex:1;padding:18px 24px}
    header.top{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:18px}
    header .title{font-size:1.2rem;font-weight:600}
    .search-inline{display:flex;gap:8px;align-items:center}
    .search-inline input{padding:8px 10px;border-radius:8px;border:1px solid #dfe7f3;min-width:220px}
    .btn{background:var(--primary);color:var(--primary-contrast);border:none;padding:8px 12px;border-radius:8px;cursor:pointer}
    .btn.ghost{background:transparent;border:1px solid #e6eef8;color:#222}
    .card{background:var(--card);padding:14px;border-radius:12px;box-shadow:0 3px 10px rgba(15,23,42,0.06)}
    .muted{color:var(--muted)}

    /* layout pieces */
    .cards{display:flex;gap:12px;margin-bottom:16px;flex-wrap:wrap}
    .card.small{flex:1;min-width:160px}
    .card.large{flex:2;min-width:300px}
    .grid-2{display:grid;grid-template-columns:1fr 420px;gap:12px}
    .grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid #eef2f6;text-align:left}
    th{font-size:0.85rem;color:var(--muted)}
    .chip{display:inline-block;padding:6px 10px;border-radius:999px;font-size:0.85rem}
    .chip.success{background:rgba(76,175,80,0.12);color:var(--success)}
    .chip.warn{background:rgba(255,193,7,0.12);color:#ffb300}
    .chip.danger{background:rgba(229,57,53,0.08);color:var(--danger)}

    /* teacher list */
    .teacher-list{display:flex;flex-direction:column;gap:10px}
    .teacher-item{display:flex;gap:12px;align-items:center;padding:10px;border-radius:10px;background:var(--card);cursor:pointer}
    .teacher-item img{width:64px;height:64px;border-radius:8px;object-fit:cover}
    .teacher-item .meta{flex:1}
    .teacher-item h4{margin:0;margin-bottom:4px}
    .teacher-item p{margin:0;color:var(--muted);font-size:0.95rem}

    /* small */
    .mb{margin-bottom:12px}
    .space{height:12px}
    .settings-row{display:flex;gap:12px;align-items:center;margin-bottom:8px}
    footer.small{margin-top:18px;font-size:0.85rem;color:var(--muted)}

    /* role header */
    .role-header{display:flex;align-items:center;gap:12px}
    .role-badge{background:rgba(0,0,0,0.06);padding:6px 10px;border-radius:8px;font-weight:600}

    /* responsive */
    @media(max-width:980px){
      .sidebar{display:none}
      .app{flex-direction:column}
      .grid-2{grid-template-columns:1fr}
      .grid-3{grid-template-columns:1fr}
    }
    @media(max-width:600px){
      #main-navbar {
        flex-direction:column;
        height:auto;
        padding:0 12px;
        align-items:flex-start;
      }
      #main-navbar > div {
        flex-direction:row;
        gap:8px;
        font-size:1rem;
      }
      #main-navbar a {
        font-size:0.95rem;
        padding:6px 0;
        display:inline-block;
      }
      .home-chooser {
        padding:8px;
        height:calc(100vh - 48px);
      }
      .chooser-card {
        padding:16px;
        max-width:100%;
        border-radius:8px;
      }
      .chooser-grid {
        flex-direction:column;
        gap:8px;
      }
      .role-card {
        min-width:0;
        padding:12px;
        font-size:0.98rem;
      }
      .content {
        padding:10px 6px;
      }
      .card {
        padding:10px;
        border-radius:8px;
      }
      header.top {
        flex-direction:column;
        gap:6px;
        align-items:flex-start;
      }
      .search-inline input {
        min-width:120px;
        font-size:0.95rem;
      }
      .btn, .btn.ghost {
        padding:7px 10px;
        font-size:0.95rem;
      }
      table th, table td {
        padding:6px;
        font-size:0.92rem;
      }
      .teacher-item img {
        width:48px;
        height:48px;
      }
    }
    /* Mobile menu button and panel styles */
    .mobile-menu-btn{display:none;align-items:center;justify-content:center;border-radius:8px;padding:6px;background:rgba(255,255,255,0.06);color:#fff;border:none}
    /* mobile menu panel hidden by default; will reuse .sidebar for colors */
    #mobile-menu{display:none;position:fixed;left:0;top:0;height:100vh;width:260px;transform:translateX(-100%);transition:transform .28s ease;z-index:1250;border-radius:0;padding-top:28px}
    #mobile-menu.open{transform:translateX(0);display:block}
    #mobile-menu .nav a{color:white}
    #mobile-menu-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.35);z-index:1200}
    #mobile-menu-overlay.open{display:block}
    @media(max-width:980px){
      .mobile-menu-btn{display:inline-flex}
    }
  </style>
</head>
<body>
  <!-- NAVBAR -->
  <nav id="main-navbar" style="width:100%;background:linear-gradient(90deg,var(--primary),var(--primary-dark));color:#fff;padding:0 32px;display:flex;align-items:center;justify-content:space-between;position:fixed;top:0;left:0;height:56px;z-index:1000;box-shadow:0 2px 8px rgba(0,0,0,0.08)">
  <div style="display:flex;align-items:center;gap:12px">
  <span class="material-icons" style="font-size:28px;">diversity_3</span>
      <span style="font-weight:600;font-size:1.15rem;letter-spacing:1px">CGR Teacher</span>
    </div>
    <div style="display:flex;gap:24px;font-size:1rem">
      <a href="#" style="color:#fff;text-decoration:none;font-weight:500;">Home</a>
      <a href="#" style="color:#fff;text-decoration:none;font-weight:500;">Sobre</a>
      <a href="#" style="color:#fff;text-decoration:none;font-weight:500;">Contato</a>
    </div>
  </nav>
  <div id="navbar-space" style="height:56px"></div> <!-- Espaço para navbar -->

  <!-- Mobile menu overlay & panel (hidden by default) -->
  <div id="mobile-menu-overlay" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.35);z-index:1200"></div>
  <aside id="mobile-menu" class="sidebar" style="display:none;position:fixed;left:0;top:0;height:100vh;width:260px;transform:translateX(-100%);transition:transform .28s ease;z-index:1250;border-radius:0;padding-top:28px;">
  </aside>

  <!-- HOME chooser -->
  <div id="home-screen" class="home-chooser" style="display:block;">
    <div class="chooser-card">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:12px">
        <div>
          <h1 style="margin:0">Simulação — Plataforma de Serviços para Crianças</h1>
          <div class="muted">Escolha um perfil para entrar no ambiente simulado (sem autenticação)</div>
        </div>
        <div>
          <button id="btnInstall" class="btn" style="display:none;">Instalar App</button>
        </div>
      </div>

      <div class="chooser-grid">
        <div class="role-card" onclick="enterRole('admin')">
          <div style="display:flex;align-items:center;gap:12px">
            <span class="material-icons" style="font-size:40px;color:var(--primary)">admin_panel_settings</span>
            <div>
              <h3>Administrador</h3>
              <p>Acesso ao painel administrativo com métricas, usuários e relatórios.</p>
            </div>
          </div>
        </div>

        <div class="role-card" onclick="enterRole('teacher')">
          <div style="display:flex;align-items:center;gap:12px">
            <span class="material-icons" style="font-size:40px;color:var(--primary)">school</span>
            <div>
              <h3>Professor(a)</h3>
              <p>Visualize suas turmas, agendamentos, frequência e mensagens.</p>
            </div>
          </div>
        </div>

        <div class="role-card" onclick="enterRole('parent')">
          <div style="display:flex;align-items:center;gap:12px">
            <span class="material-icons" style="font-size:40px;color:var(--primary)">family_restroom</span>
            <div>
              <h3>Pais / Responsáveis</h3>
              <p>Buscar professoras, ver agendamentos do(s) filho(s) e comunicar-se com professoras.</p>
            </div>
          </div>
        </div>
      </div>

      <div style="margin-top:18px" class="muted">Este é um ambiente de simulação. Nenhum dado é enviado a servidores.</div>
    </div>
  </div>

  <!-- APP shell (hidden until a role is selected) -->
  <div id="app-shell" class="app" style="display:none;">
    <aside id="sidebar" class="sidebar" aria-label="menu"></aside>

    <main class="content">
      <header class="top">
        <div class="title" id="page-title">Simulação Plataforma</div>
          <button id="mobile-menu-btn" class="mobile-menu-btn" aria-label="Abrir menu" title="Menu">
            <span class="material-icons">menu</span>
          </button>
        <div class="search-inline">
          <input id="globalSearch" placeholder="Pesquisar..." />
          <button class="btn" id="btnQuickSearch">Pesquisar</button>
          <button class="btn ghost" id="btnBackHome" style="margin-left:8px">Sair</button>
        </div>
      </header>

      <!-- Admin Views -->
      <section id="view-admin-dashboard" style="display:none;">
        <div class="role-header mb">
          <div class="role-badge">Administrador</div>
          <div class="muted">Painel administrativo — visão geral</div>
        </div>

        <div class="cards">
          <div class="card small">
            <div class="muted">Total de Usuários</div>
            <h2 id="stat-users">0</h2>
            <div class="muted">Última atualização: <span id="stat-usertime">--</span></div>
          </div>
          <div class="card small">
            <div class="muted">Total de Professoras</div>
            <h2 id="stat-teachers">0</h2>
            <div class="muted">Ativas / Verificadas</div>
          </div>
          <div class="card small">
            <div class="muted">Agendamentos Totais</div>
            <h2 id="stat-bookings">0</h2>
            <div class="muted">Este mês</div>
          </div>
          <div class="card large">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div><strong>Gráfico de agendamentos (30 dias)</strong><div class="muted">Dados simulados</div></div>
              <div><button class="btn" onclick="randomizeData()">Atualizar</button></div>
            </div>
            <canvas id="chartBookingsAdmin" style="margin-top:12px;"></canvas>
          </div>
        </div>

        <div class="grid-2">
          <div>
            <div class="card mb">
              <h3>Atividade Recente</h3>
              <ul id="recentActivity" style="list-style:none;padding:0;margin:0"></ul>
            </div>

            <div class="card mb">
              <h3>Top Professoras</h3>
              <div id="topTeachers"></div>
            </div>
          </div>

          <div>
            <div class="card mb">
              <h3>Resumo Financeiro (simulado)</h3>
              <p class="muted">Receita total, taxa da plataforma e repasses</p>
              <div style="display:flex;gap:10px;margin-top:12px">
                <div style="flex:1">
                  <div class="muted">Receita</div>
                  <h3 id="stat-revenue">R$ 0,00</h3>
                </div>
                <div style="flex:1">
                  <div class="muted">Taxas (10%)</div>
                  <h3 id="stat-fees">R$ 0,00</h3>
                </div>
              </div>
            </div>

            <div class="card mb">
              <h3>Disponibilidade Hoje</h3>
              <div id="availabilityList"></div>
            </div>
          </div>
        </div>
      </section>

      <section id="view-admin-teachers" style="display:none;">
        <h2>Professoras</h2>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
          <div style="display:flex;gap:8px">
            <select id="filterAge"><option value="">Todas as idades</option><option value="2-4">2-4</option><option value="4-6">4-6</option><option value="6-12">6-12</option></select>
            <input id="filterService" placeholder="Serviço (ex: Alfabetização)" />
            <button class="btn" onclick="renderTeachers('admin')">Aplicar</button>
          </div>
        </div>
        <div id="teacher-list" class="teacher-list"></div>
      </section>

      <section id="view-admin-bookings" style="display:none;">
        <h2>Agendamentos</h2>
        <div class="card mb">
          <table id="tableBookings">
            <thead><tr><th>ID</th><th>Pais</th><th>Professora</th><th>Serviço</th><th>Data/Hora</th><th>Status</th><th>Ações</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

      <section id="view-admin-reports" style="display:none;">
        <h2>Relatórios</h2>
        <div class="card mb">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <strong>Relatório de serviços</strong>
              <div class="muted">Filtro por serviço / período (simulado)</div>
            </div>
            <div>
              <button class="btn" onclick="exportCSVAdmin()">Exportar CSV</button>
            </div>
          </div>

          <div style="margin-top:12px">
            <table id="reportTable">
              <thead><tr><th>Serviço</th><th>QTD</th><th>Receita</th><th>Taxa</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </section>

      <section id="view-admin-users" style="display:none;">
        <h2>Usuários</h2>
        <div class="card mb">
          <table id="usersTable">
            <thead><tr><th>Nome</th><th>Email</th><th>Tipo</th><th>Status</th><th>Ações</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

      <section id="view-admin-settings" style="display:none;">
        <h2>Configurações</h2>
        <div class="card">
          <div class="settings-row">
            <label>Taxa da plataforma (%)</label>
            <input id="cfgFee" type="number" step="0.1" min="0" value="10" style="width:100px;padding:8px;border-radius:8px;border:1px solid #e6eef8" />
            <button class="btn" onclick="saveSettings()">Salvar</button>
          </div>

          <div class="settings-row">
            <label>Intervalo de atualização (seg)</label>
            <input id="cfgInterval" type="number" min="5" value="20" style="width:100px;padding:8px;border-radius:8px;border:1px solid #e6eef8" />
            <div class="muted">Somente simulado — altera velocidade de auto-refresh</div>
          </div>

          <div style="margin-top:12px">
            <button class="btn" onclick="resetData()">Resetar Dados Simulados</button>
          </div>
          <footer class="small">Configurações salvas localmente no navegador (localStorage)</footer>
        </div>
      </section>

      <!-- TEACHER VIEWS -->
      <section id="view-teacher-dashboard" style="display:none;">
        <div class="role-header mb"><div class="role-badge">Professor(a)</div><div class="muted">Painel do professor — suas aulas e alunos</div></div>
        <div class="cards">
          <div class="card small"><div class="muted">Aulas Hoje</div><h2 id="t-stat-today">0</h2></div>
          <div class="card small"><div class="muted">Alunos</div><h2 id="t-stat-students">0</h2></div>
          <div class="card small"><div class="muted">Mensagens</div><h2 id="t-stat-messages">0</h2></div>
        </div>

        <div class="card mb">
          <h3>Minhas Aulas</h3>
          <table id="t-tableLessons">
            <thead><tr><th>Data</th><th>Hora</th><th>Aluno</th><th>Serviço</th><th>Status</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="card mb">
          <h3>Mensagens</h3>
          <div id="t-messages"></div>
        </div>
      </section>

      <section id="view-teacher-profile" style="display:none;">
        <h2>Meu Perfil</h2>
        <div class="card">
          <div id="t-profile"></div>
        </div>
      </section>

      <!-- PARENT VIEWS -->
      <section id="view-parent-dashboard" style="display:none;">
        <div class="role-header mb"><div class="role-badge">Pais / Responsáveis</div><div class="muted">Acompanhe seus filhos e agendamentos</div></div>

        <div class="cards">
          <div class="card small"><div class="muted">Meus Agendamentos</div><h2 id="p-stat-bookings">0</h2></div>
          <div class="card small"><div class="muted">Mensagens</div><h2 id="p-stat-messages">0</h2></div>
          <div class="card small"><div class="muted">Professoras Favoritas</div><h2 id="p-stat-favs">0</h2></div>
        </div>

        <div class="card mb">
          <h3>Buscar Professoras</h3>
          <div style="display:flex;gap:8px;margin-bottom:8px">
            <input id="p-search" placeholder="Buscar por nome ou serviço" style="flex:1;padding:8px;border-radius:8px;border:1px solid #e6eef8" />
            <button class="btn" onclick="renderParentSearch()">Pesquisar</button>
          </div>
          <div id="p-search-results" class="teacher-list"></div>
        </div>

        <div class="card mb">
          <h3>Meus Agendamentos</h3>
          <table id="p-tableBookings">
            <thead><tr><th>ID</th><th>Professora</th><th>Serviço</th><th>Data</th><th>Status</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

      <section id="view-parent-profile" style="display:none;">
        <h2>Perfil do Responsável</h2>
        <div class="card" id="p-profile"></div>
      </section>

      <div class="space"></div>
      <footer class="small">Simulação local • Sem backend</footer>
    </main>
  </div>

  <script>
    /***********************
     * MOCK DATA GENERATION
     ***********************/
    const MOCK = {
      users: [],
      teachers: [],
      bookings: [],
      services: [
        { id:1, name:'Cuidados Gerais' },
        { id:2, name:'Alfabetização - Infantil' },
        { id:3, name:'Acompanhamento Escolar' }
      ],
      students: []
    };

    const rand = (min,max) => Math.floor(Math.random()*(max-min+1))+min;
    const money = n => 'R$ ' + n.toLocaleString('pt-BR', {minimumFractionDigits:2, maximumFractionDigits:2});

    // helper: converte hex CSS var para rgba
    function hexToRgba(hex, alpha){
      try{
        hex = hex.trim();
        if(hex.startsWith('var(')){
          // resolve var(--primary)
          const name = hex.replace(/var\(|\)/g,'').trim();
          hex = getComputedStyle(document.documentElement).getPropertyValue(name).trim();
        }
        if(hex.indexOf('#')===0) hex = hex.substring(1);
        if(hex.length===3) hex = hex.split('').map(c=>c+c).join('');
        const r = parseInt(hex.substring(0,2),16);
        const g = parseInt(hex.substring(2,4),16);
        const b = parseInt(hex.substring(4,6),16);
        return `rgba(${r},${g},${b},${alpha})`;
      }catch(e){
        return `rgba(255,64,129,${alpha})`; // fallback rosa
      }
    }

    function seedMockData() {
      MOCK.users = [
        { id:1, name:'Carlos Souza', email:'carlos@exemplo.com', type:'PARENT', active:true },
        { id:2, name:'Mariana Lopes', email:'mariana@ex.com', type:'TEACHER', active:true },
        { id:3, name:'João Silva', email:'joao@ex.com', type:'PARENT', active:true },
        { id:4, name:'Admin Local', email:'admin@ex.com', type:'ADMIN', active:true }
      ];

      MOCK.students = [
        { id:1, name:'Pedro Souza', birthdate:'2019-04-15', parentId:1 },
        { id:2, name:'Luiza Silva', birthdate:'2017-07-20', parentId:3 }
      ];

      const tpls = [
        { name:'Cristiane Weber', bio:'Especialista em alfabetização infantil com 8 anos.', ageRange:'4-8', rating:4.8, img:'https://i.pravatar.cc/150?img=5' },
        { name:'Ana Clara', bio:'Professora de reforço e acompanhamento pedagógico.', ageRange:'6-12', rating:4.6, img:'https://i.pravatar.cc/150?img=9' },
        { name:'Patrícia Lima', bio:'Cuidadora e educadora infantil (formada em pedagogia).', ageRange:'2-6', rating:4.9, img:'https://i.pravatar.cc/150?img=16' },
        { name:'Joana Almeida', bio:'Atividades lúdicas e alfabetização inicial.', ageRange:'3-7', rating:4.7, img:'https://i.pravatar.cc/150?img=10' },
        { name:'Beatriz Santos', bio:'Auxílio escolar e reforço em matemática.', ageRange:'7-12', rating:4.5, img:'https://i.pravatar.cc/150?img=19' }
      ];
      MOCK.teachers = tpls.map((t,i) => ({
        id:100+i,
        name:t.name,
        bio:t.bio,
        ageRange:t.ageRange,
        rating:t.rating,
        img:t.img,
        services: [MOCK.services[rand(0,2)].name],
        verified: Math.random() > 0.2,
        hourly: (rand(20,80) + rand(0,99)/100).toFixed(2),
        availability: generateAvailability()
      }));

      // bookings
      MOCK.bookings = [];
      const parents = MOCK.users.filter(u=>u.type==='PARENT');
      for(let i=0;i<28;i++){
        const teacher = MOCK.teachers[rand(0,MOCK.teachers.length-1)];
        const parent = parents[rand(0,parents.length-1)];
        const serv = MOCK.services[rand(0,MOCK.services.length-1)];
        const d = new Date();
        d.setDate(d.getDate() - rand(0,20) + rand(0,20));
        d.setHours(rand(8,18), [0,15,30,45][rand(0,3)]);
        const price = parseFloat(teacher.hourly) + rand(0,40);
        MOCK.bookings.push({
          id: 500 + i,
          parent: parent.name,
          parentId: parent.id,
          teacher: teacher.name,
          teacherId: teacher.id,
          service: serv.name,
          datetime: d.toISOString(),
          status: ['REQUESTED','CONFIRMED','COMPLETED','CANCELLED'][rand(0,3)],
          price: price
        });
      }
    }

    function generateAvailability() {
      const days = ['Seg','Ter','Qua','Qui','Sex','Sáb'];
      return days.map(d => ({ day:d, slots: rand(2,5) }));
    }

    /***********************
     * STATE & SETTINGS
     ***********************/
    const Settings = {
      feePercent: parseFloat(localStorage.getItem('cfg_fee') || '10'),
      updateInterval: parseInt(localStorage.getItem('cfg_interval') || '20'),
      role: null,
      currentUserId: null // when simulating teacher/parent choose a default
    };
    function saveSettingsToLocal() {
      localStorage.setItem('cfg_fee', String(Settings.feePercent));
      localStorage.setItem('cfg_interval', String(Settings.updateInterval));
    }

    /***********************
     * UI / ROUTING
     ***********************/
    let chartAdmin = null, chartTeacher = null;

    function enterRole(role) {
      // initialize app
      document.getElementById('home-screen').style.display = 'none';
      document.getElementById('app-shell').style.display = 'flex';
      Settings.role = role;
      // choose a default user for teacher/parent simulation
      if(role === 'teacher') {
        const t = MOCK.teachers[0];
        Settings.currentUserId = t ? t.id : null;
      } else if(role === 'parent') {
        const p = MOCK.users.find(u=>u.type==='PARENT');
        Settings.currentUserId = p ? p.id : null;
      } else {
        Settings.currentUserId = MOCK.users.find(u=>u.type==='ADMIN')?.id || 4;
      }
      buildSidebarForRole(role);
      // default route for role
      if(role === 'admin') {
        location.hash = '#/admin/dashboard';
      } else if(role === 'teacher') {
        location.hash = '#/teacher/dashboard';
      } else {
        location.hash = '#/parent/dashboard';
      }
      route();
    }

    function buildSidebarForRole(role) {
      const sb = document.getElementById('sidebar');
      sb.innerHTML = '';
      const brand = document.createElement('div');
  brand.className = 'brand';
  brand.innerHTML = `<span class="material-icons">diversity_3</span> CGR Teacher`;
      sb.appendChild(brand);
      brand.style.cursor = 'pointer';
      brand.onclick = function() {
        document.getElementById('app-shell').style.display = 'none';
        document.getElementById('home-screen').style.display = 'block';
        Settings.role = null;
        location.hash = '';
      };
      const nav = document.createElement('nav');
      nav.className = 'nav';
      if(role === 'admin') {
        nav.innerHTML = `
          <a href="#/admin/dashboard" data-route="/admin/dashboard"><span class="material-icons">dashboard</span> Dashboard</a>
          <a href="#/admin/teachers" data-route="/admin/teachers"><span class="material-icons">school</span> Professoras</a>
          <a href="#/admin/bookings" data-route="/admin/bookings"><span class="material-icons">event</span> Agendamentos</a>
          <a href="#/admin/reports" data-route="/admin/reports"><span class="material-icons">insert_chart</span> Relatórios</a>
          <a href="#/admin/users" data-route="/admin/users"><span class="material-icons">people</span> Usuários</a>
          <a href="#/admin/settings" data-route="/admin/settings"><span class="material-icons">settings</span> Configurações</a>
        `;
      } else if(role === 'teacher') {
        nav.innerHTML = `
          <a href="#/teacher/dashboard" data-route="/teacher/dashboard"><span class="material-icons">dashboard</span> Meu Painel</a>
          <a href="#/teacher/lessons" data-route="/teacher/lessons"><span class="material-icons">event_note</span> Minhas Aulas</a>
          <a href="#/teacher/students" data-route="/teacher/students"><span class="material-icons">people</span> Alunos</a>
          <a href="#/teacher/messages" data-route="/teacher/messages"><span class="material-icons">chat</span> Mensagens</a>
          <a href="#/teacher/profile" data-route="/teacher/profile"><span class="material-icons">person</span> Perfil</a>
        `;
      } else {
        nav.innerHTML = `
          <a href="#/parent/dashboard" data-route="/parent/dashboard"><span class="material-icons">home</span> Pais</a>
          <a href="#/parent/search" data-route="/parent/search"><span class="material-icons">search</span> Buscar Professoras</a>
          <a href="#/parent/bookings" data-route="/parent/bookings"><span class="material-icons">event</span> Meus Agendamentos</a>
          <a href="#/parent/messages" data-route="/parent/messages"><span class="material-icons">chat</span> Mensagens</a>
          <a href="#/parent/profile" data-route="/parent/profile"><span class="material-icons">person</span> Perfil</a>
        `;
      }
      sb.appendChild(nav);
      // Adiciona event listener para navegação dos links do sidebar
      setTimeout(() => {
        sb.querySelectorAll('.nav a').forEach(a => {
          a.addEventListener('click', function(e) {
            e.preventDefault();
            location.hash = a.getAttribute('href');
            // Removido scroll automático
          });
        });
      }, 0);

      const meta = document.createElement('div');
      meta.className = 'meta';
      meta.innerHTML = `<div>Simulação • perfil: <strong>${role.toUpperCase()}</strong></div><small>Dados mock — sem autenticação</small>`;
      sb.appendChild(meta);

      // Populate mobile menu panel (clone of sidebar) for small screens
      try{
        const mobileMenu = document.getElementById('mobile-menu');
        if(mobileMenu){
          mobileMenu.innerHTML = '';
          const mBrand = brand.cloneNode(true);
          mobileMenu.appendChild(mBrand);
          // clone nav and attach
          const mNav = nav.cloneNode(true);
          mNav.className = 'nav';
          mobileMenu.appendChild(mNav);
          const mMeta = meta.cloneNode(true);
          mobileMenu.appendChild(mMeta);
          // wire mobile nav links: set hash and close menu
          setTimeout(()=>{
            mobileMenu.querySelectorAll('.nav a').forEach(a => {
              a.addEventListener('click', function(e){ e.preventDefault(); location.hash = a.getAttribute('href'); toggleMobileMenu(false); });
            });
          }, 0);
        }
      }catch(e){console.warn('mobile menu build failed', e)}

      // back home
      document.getElementById('btnBackHome').onclick = () => {
        document.getElementById('app-shell').style.display = 'none';
        document.getElementById('home-screen').style.display = 'block';
        Settings.role = null;
        location.hash = '';
      };
    }

    // set active nav highlight
    function setActiveNav(route) {
      document.querySelectorAll('.nav a').forEach(a => {
        a.classList.toggle('active', a.dataset.route === route);
      });
    }

    // Routing
    function route() {
      const hash = location.hash || '';
      // admin routes
      if(hash.startsWith('#/admin')) {
        const route = hash.replace('#/admin','').replace('#','') || '/dashboard';
        // map to views
        setActiveNav('/admin' + route);
        document.getElementById('page-title').innerText = 'Administrador — ' + (route.replace('/','') || 'dashboard');
        hideAllViews();
        switch(route) {
          case '/dashboard': renderAdminDashboard(); break;
          case '/teachers': renderTeachers('admin'); break;
          case '/bookings': renderBookings(); break;
          case '/reports': renderReports(); break;
          case '/users': renderUsers(); break;
          case '/settings': showView('view-admin-settings'); break;
          default: renderAdminDashboard(); break;
        }
      }
      // teacher routes
      else if(hash.startsWith('#/teacher')) {
        const route = hash.replace('#/teacher','').replace('#','') || '/dashboard';
        setActiveNav('/teacher' + route);
        document.getElementById('page-title').innerText = 'Professor(a) — ' + (route.replace('/','') || 'dashboard');
        hideAllViews();
        switch(route) {
          case '/dashboard': renderTeacherDashboard(); break;
          case '/lessons': renderTeacherLessons(); break;
          case '/students': renderTeacherStudents(); break;
          case '/messages': renderTeacherMessages(); break;
          case '/profile': showView('view-teacher-profile'); renderTeacherProfile(); break;
          default: renderTeacherDashboard(); break;
        }
      }
      // parent routes
      else if(hash.startsWith('#/parent')) {
        const route = hash.replace('#/parent','').replace('#','') || '/dashboard';
        setActiveNav('/parent' + route);
        document.getElementById('page-title').innerText = 'Pais — ' + (route.replace('/','') || 'Início');
        hideAllViews();
        switch(route) {
          case '/dashboard': renderParentDashboard(); break;
          case '/search': showView('view-parent-dashboard'); renderParentSearch(); break;
          case '/bookings': renderParentBookings(); break;
          case '/messages': renderParentMessages(); break;
          case '/profile': showView('view-parent-profile'); renderParentProfile(); break;
          default: renderParentDashboard(); break;
        }
      }
    }

    function hideAllViews() {
      // admin
      document.querySelectorAll('[id^="view-admin"]').forEach(e=>e.style.display='none');
      // teacher
      document.querySelectorAll('[id^="view-teacher"]').forEach(e=>e.style.display='none');
      // parent
      document.querySelectorAll('[id^="view-parent"]').forEach(e=>e.style.display='none');
    }

    /***********************
     * RENDERERS — ADMIN
     ***********************/
    function renderAdminDashboard() {
      showView('view-admin-dashboard');
      document.getElementById('stat-users').innerText = MOCK.users.length;
      document.getElementById('stat-teachers').innerText = MOCK.teachers.length;
      document.getElementById('stat-bookings').innerText = MOCK.bookings.length;
      document.getElementById('stat-usertime').innerText = new Date().toLocaleTimeString();

      const revenue = MOCK.bookings.reduce((s,b)=>s + (b.price||0), 0);
      const fees = revenue * (Settings.feePercent/100);
      document.getElementById('stat-revenue').innerText = money(revenue);
      document.getElementById('stat-fees').innerText = money(fees);

      const act = MOCK.bookings.slice(-8).reverse();
      document.getElementById('recentActivity').innerHTML = act.map(a => `<li class="mb card" style="padding:8px"><strong>${a.teacher}</strong> - ${a.service} • <span class="muted">${formatDateIso(a.datetime)}</span></li>`).join('');

      document.getElementById('topTeachers').innerHTML = MOCK.teachers.slice(0,5).map(t => `<div style="padding:8px;display:flex;align-items:center;gap:8px;border-bottom:1px solid #f1f6fb"><img src="${t.img}" width="42" height="42" style="border-radius:6px" /><div><strong>${t.name}</strong><div class="muted">${t.services.join(', ')} • ${t.ageRange} anos</div></div></div>`).join('');

      document.getElementById('availabilityList').innerHTML = MOCK.teachers.slice(0,5).map(t=>`<div style="padding:8px;border-bottom:1px solid #f1f6fb"><strong>${t.name}</strong><div class="muted">${t.availability.map(a=>a.day + ' ('+a.slots+' slots)').join(' • ')}</div></div>`).join('');

      // chart last 30 days
      const labels = [];
      const data = [];
      for(let i=29;i>=0;i--){
        const d = new Date(); d.setDate(d.getDate()-i); labels.push(`${d.getDate()}/${d.getMonth()+1}`);
        const count = MOCK.bookings.filter(b => sameDay(new Date(b.datetime), d)).length;
        data.push(count + rand(0,3));
      }
      const ctx = document.getElementById('chartBookingsAdmin').getContext('2d');
      if(chartAdmin) chartAdmin.destroy();
      // use theme colors (primary and primary-dark) and create a gradient fill
      const primaryVar = (getComputedStyle(document.documentElement).getPropertyValue('--primary') || '#ff4081').trim();
      const primaryDarkVar = (getComputedStyle(document.documentElement).getPropertyValue('--primary-dark') || '#81d4fa').trim();
      const grad = ctx.createLinearGradient(0,0,0,200);
      grad.addColorStop(0, hexToRgba(primaryDarkVar, 0.18));
      grad.addColorStop(1, hexToRgba(primaryVar, 0.06));
      chartAdmin = new Chart(ctx, {
        type:'line',
        data:{ labels, datasets:[{ label:'Agendamentos', data, tension:0.3, fill:true, backgroundColor: grad, borderColor: hexToRgba(primaryVar, 0.95), pointBackgroundColor: hexToRgba(primaryDarkVar, 1), pointBorderColor: hexToRgba(primaryVar, 1), pointRadius:3 }]},
        options:{ plugins:{legend:{display:false}}, scales:{ x:{grid:{display:false}}, y:{beginAtZero:true, ticks:{precision:0}}}}
      });
    }

    function renderTeachers(context='admin') {
      // display correct view
      if(context==='admin') { showView('view-admin-teachers'); document.getElementById('filterAge').value=''; document.getElementById('filterService').value=''; }
      const list = document.getElementById('teacher-list');
      const ageFilter = document.getElementById('filterAge') ? document.getElementById('filterAge').value : '';
      const serviceFilter = document.getElementById('filterService') ? document.getElementById('filterService').value.toLowerCase() : '';

      const filtered = MOCK.teachers.filter(t => {
        let ok = true;
        if(ageFilter) ok = ok && (t.ageRange.replace(/\s/g,'') === ageFilter);
        if(serviceFilter) ok = ok && (t.services.join(' ').toLowerCase().includes(serviceFilter) || t.name.toLowerCase().includes(serviceFilter));
        return ok;
      });

      list.innerHTML = filtered.map(t => `
        <div class="teacher-item card" onclick="openTeacher(${t.id})">
          <img src="${t.img}" alt="${t.name}" />
          <div class="meta">
            <h4>${t.name} <span style="font-size:0.9rem;color:var(--muted)">• ${t.ageRange} anos</span></h4>
            <p>${t.bio}</p>
            <div style="margin-top:8px">
              <span class="chip ${t.verified ? 'success' : 'warn'}">${t.verified ? 'Verificada' : 'Pendente'}</span>
              <span style="margin-left:8px" class="muted">Avaliação: ${t.rating} ⭐</span>
            </div>
          </div>
          <div style="text-align:right">
            <div class="muted">R$ ${Number(t.hourly).toFixed(2)}/h</div>
            <button class="btn" style="margin-top:8px" onclick="event.stopPropagation(); bookNow(${t.id})">Agendar</button>
          </div>
        </div>
      `).join('');
    }

    function renderBookings() {
      showView('view-admin-bookings');
      const tbody = document.querySelector('#tableBookings tbody');
      tbody.innerHTML = MOCK.bookings.map(b => `
        <tr>
          <td>${b.id}</td>
          <td>${b.parent}</td>
          <td>${b.teacher}</td>
          <td>${b.service}</td>
          <td>${formatDateIso(b.datetime)}</td>
          <td><span class="chip ${b.status==='COMPLETED'?'success':b.status==='CANCELLED'?'danger':'warn'}">${b.status}</span></td>
          <td>
            <button class="btn" onclick="editBooking(${b.id})">Editar</button>
            <button class="btn ghost" onclick="cancelBooking(${b.id})">Cancelar</button>
          </td>
        </tr>
      `).join('');
    }

    function renderReports() {
      showView('view-admin-reports');
      const map = {};
      MOCK.bookings.forEach(b => {
        if(!map[b.service]) map[b.service] = {q:0, revenue:0};
        map[b.service].q++;
        map[b.service].revenue += b.price || 0;
      });
      const tbody = document.querySelector('#reportTable tbody');
      tbody.innerHTML = Object.keys(map).map(k => {
        const entry = map[k];
        const fee = entry.revenue * (Settings.feePercent/100);
        return `<tr><td>${k}</td><td>${entry.q}</td><td>${money(entry.revenue)}</td><td>${money(fee)}</td></tr>`;
      }).join('');
    }

    function renderUsers() {
      showView('view-admin-users');
      const tbody = document.querySelector('#usersTable tbody');
      tbody.innerHTML = MOCK.users.map(u => `
        <tr>
          <td>${u.name}</td>
          <td>${u.email}</td>
          <td>${u.type === 'PARENT' ? 'Pais' : u.type === 'TEACHER' ? 'Professora' : u.type === 'ADMIN' ? 'Admin' : u.type}</td>
          <td>${u.active ? '<span class="chip success">Ativo</span>' : '<span class="chip danger">Inativo</span>'}</td>
          <td><button class="btn" onclick="editUser(${u.id})">Editar</button></td>
        </tr>
      `).join('');
    }

    /***********************
     * RENDERERS — TEACHER
     ***********************/
    function renderTeacherDashboard() {
      showView('view-teacher-dashboard');
      // stats
      const lessons = MOCK.bookings.filter(b => b.teacherId === Settings.currentUserId);
      document.getElementById('t-stat-today').innerText = lessons.filter(l => sameDay(new Date(l.datetime), new Date())).length;
      document.getElementById('t-stat-students').innerText = MOCK.students.length;
      document.getElementById('t-stat-messages').innerText = rand(0,10);

      // lessons table
      const tbody = document.querySelector('#t-tableLessons tbody');
      const upcoming = lessons.slice(-10).reverse();
      tbody.innerHTML = upcoming.map(l => `<tr><td>${(new Date(l.datetime)).toLocaleDateString()}</td><td>${(new Date(l.datetime)).toLocaleTimeString()}</td><td>${l.parent}</td><td>${l.service}</td><td><span class="chip ${l.status==='COMPLETED'?'success':l.status==='CANCELLED'?'danger':'warn'}">${l.status}</span></td></tr>`).join('');

      // messages
      const msgs = document.getElementById('t-messages');
      msgs.innerHTML = `<div style="padding:8px" class="muted">Mensagens simuladas com pais</div>` + MOCK.bookings.slice(-3).map(m=>`<div class="card mb" style="padding:8px"><strong>${m.parent}</strong>: <div class="muted">${m.service} • ${formatDateIso(m.datetime)}</div></div>`).join('');
    }

    function renderTeacherLessons() { renderTeacherDashboard(); }
    function renderTeacherStudents() {
      showView('view-teacher-dashboard');
      // reuse area: replace lessons table with students list
      const tbody = document.querySelector('#t-tableLessons tbody');
      tbody.innerHTML = MOCK.students.map(s => `<tr><td>${s.name}</td><td>${s.birthdate}</td><td>—</td><td>—</td><td><span class="chip success">Ativo</span></td></tr>`).join('');
    }
    function renderTeacherMessages() {
      showView('view-teacher-dashboard');
      document.getElementById('t-messages').innerHTML = MOCK.bookings.filter(b=>b.teacherId===Settings.currentUserId).slice(-5).map(m=>`<div class="card mb" style="padding:8px"><strong>${m.parent}</strong>: ${m.service} • <div class="muted">${formatDateIso(m.datetime)}</div></div>`).join('');
    }
    function renderTeacherProfile() {
      showView('view-teacher-profile');
      const t = MOCK.teachers.find(x=>x.id===Settings.currentUserId);
      document.getElementById('t-profile').innerHTML = `<div style="display:flex;gap:12px;align-items:center"><img src="${t.img}" width="120" height="120" style="border-radius:12px"/><div><h3>${t.name}</h3><div class="muted">${t.services.join(', ')} • ${t.ageRange} anos</div><p style="margin-top:8px">${t.bio}</p><div class="muted">Valor/h: R$ ${Number(t.hourly).toFixed(2)}</div></div></div>`;
    }

    /***********************
     * RENDERERS — PARENT
     ***********************/
    function renderParentDashboard() {
      showView('view-parent-dashboard');
      const myBookings = MOCK.bookings.filter(b=>b.parentId === Settings.currentUserId);
      document.getElementById('p-stat-bookings').innerText = myBookings.length;
      document.getElementById('p-stat-messages').innerText = rand(0,6);
      document.getElementById('p-stat-favs').innerText = rand(0,4);

      // small search results default
      renderParentSearch();
      // bookings table
      const tbody = document.querySelector('#p-tableBookings tbody');
      tbody.innerHTML = myBookings.map(b=>`<tr><td>${b.id}</td><td>${b.teacher}</td><td>${b.service}</td><td>${formatDateIso(b.datetime)}</td><td><span class="chip ${b.status==='COMPLETED'?'success':b.status==='CANCELLED'?'danger':'warn'}">${b.status}</span></td></tr>`).join('');
    }

    function renderParentSearch() {
      showView('view-parent-dashboard');
      const q = document.getElementById('p-search') ? document.getElementById('p-search').value.toLowerCase().trim() : '';
      const where = q ? (t=> t.name.toLowerCase().includes(q) || t.services.join(' ').toLowerCase().includes(q)) : (_=>true);
      const results = MOCK.teachers.filter(where);
      document.getElementById('p-search-results').innerHTML = results.map(t=>`<div class="teacher-item card"><img src="${t.img}"/><div class="meta"><h4>${t.name}</h4><p class="muted">${t.bio}</p></div><div style="text-align:right"><div class="muted">R$ ${Number(t.hourly).toFixed(2)}/h</div><button class="btn" onclick="bookNowAsParent(${t.id})">Agendar</button></div></div>`).join('');
    }

    function renderParentBookings() {
      showView('view-parent-dashboard');
      // same as dashboard bookings table
      renderParentDashboard();
    }

    function renderParentMessages() {
      showView('view-parent-dashboard');
      // simple messages area
      const el = document.getElementById('p-search-results');
      el.innerHTML = `<div class="muted">Mensagens (simulado)</div>` + MOCK.bookings.filter(b=>b.parentId===Settings.currentUserId).slice(-5).map(m=>`<div class="card mb" style="padding:8px"><strong>${m.teacher}</strong>: ${m.service} • <div class="muted">${formatDateIso(m.datetime)}</div></div>`).join('');
    }

    function renderParentProfile() {
      showView('view-parent-profile');
      const p = MOCK.users.find(u=>u.id===Settings.currentUserId);
      const children = MOCK.students.filter(s=>s.parentId === Settings.currentUserId);
      document.getElementById('p-profile').innerHTML = `<h3>${p.name}</h3><div class="muted">${p.email}</div><div style="margin-top:12px"><strong>Crianças:</strong><ul>${children.map(c=>`<li>${c.name} — nascido em ${c.birthdate}</li>`).join('')}</ul></div>`;
    }

    /***********************
     * COMMON INTERACTIONS
     ***********************/
    function showView(id) {
      // hide all sections inside content
      document.querySelectorAll('main section').forEach(s => s.style.display = 'none');
      const el = document.getElementById(id);
      if(el) el.style.display = 'block';
    }

    function openTeacher(id) {
      const t = MOCK.teachers.find(x=>x.id===id);
      if(!t) return alert('Professora não encontrada');
      const html = `<div style="max-width:700px"><div style="display:flex;gap:12px"><img src="${t.img}" width="120" height="120" style="border-radius:12px" /><div><h3 style="margin:0">${t.name}</h3><div class="muted">${t.services.join(', ')} • ${t.ageRange} anos</div><p style="margin-top:12px">${t.bio}</p><div style="margin-top:8px"><strong>Horário:</strong> ${t.availability.map(a=>a.day+': '+a.slots+' slots').join(' • ')}</div><div style="margin-top:8px"><strong>Valor/h:</strong> R$ ${Number(t.hourly).toFixed(2)}</div><div style="margin-top:12px"><button class="btn" onclick="bookNow(${t.id})">Agendar</button><button style="margin-left:8px;padding:8px;border-radius:8px;border:1px solid #e6eef8;background:white;cursor:pointer" onclick="closeDialog()">Fechar</button></div></div></div></div>`;
      showDialog('Perfil da Professora', html);
    }

    function bookNow(teacherId) {
      closeDialog();
      const t = MOCK.teachers.find(x=>x.id===teacherId);
      const parent = MOCK.users.find(u=>u.type==='PARENT') || {name:'Pai Simulado', id:1};
      const dt = new Date(); dt.setDate(dt.getDate()+rand(1,7)); dt.setHours(rand(9,17), 0, 0, 0);
      const price = parseFloat(t.hourly) + rand(0,40);
      const booking = { id: 900 + MOCK.bookings.length + 1, parent: parent.name, parentId: parent.id, teacher: t.name, teacherId: t.id, service: t.services[0] || MOCK.services[0].name, datetime: dt.toISOString(), status: 'REQUESTED', price };
      MOCK.bookings.push(booking);
      alert('Agendamento solicitado (simulado) para ' + t.name + ' em ' + dt.toLocaleString());
      refreshViews();
    }

    function bookNowAsParent(teacherId) {
      // similar but uses currently simulated parent
      const t = MOCK.teachers.find(x=>x.id===teacherId);
      const parent = MOCK.users.find(u=>u.id===Settings.currentUserId) || {name:'Pai Simulado', id:1};
      const dt = new Date(); dt.setDate(dt.getDate()+rand(1,7)); dt.setHours(rand(9,17), 0, 0, 0);
      const price = parseFloat(t.hourly) + rand(0,40);
      const booking = { id: 1000 + MOCK.bookings.length + 1, parent: parent.name, parentId: parent.id, teacher: t.name, teacherId: t.id, service: t.services[0] || MOCK.services[0].name, datetime: dt.toISOString(), status: 'REQUESTED', price };
      MOCK.bookings.push(booking);
      alert('Agendamento solicitado (simulado) para ' + t.name + ' em ' + dt.toLocaleString());
      refreshViews();
    }

    function closeDialog(){ const d = document.querySelector('.dialog-overlay'); if(d) d.remove(); }
    function showDialog(title, html) {
      closeDialog();
      const overlay = document.createElement('div');
      overlay.className='dialog-overlay';
      overlay.style.position='fixed'; overlay.style.inset='0'; overlay.style.background='rgba(2,6,23,0.4)'; overlay.style.display='flex'; overlay.style.alignItems='center'; overlay.style.justifyContent='center'; overlay.style.zIndex=9999;
      const box = document.createElement('div'); box.className='card'; box.style.maxWidth='820px'; box.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><h3>${title}</h3><button onclick="closeDialog()" style="background:#efefef;border:none;padding:6px;border-radius:8px">Fechar</button></div><div style="margin-top:12px">${html}</div>`;
      overlay.appendChild(box); document.body.appendChild(overlay);
    }

    function editUser(id) {
      const u = MOCK.users.find(x=>x.id===id);
      if(!u) return;
      const html = `<div style="display:flex;flex-direction:column;gap:8px"><label>Nome <input id="dlg_name" value="${u.name}" style="width:100%;padding:8px;border-radius:8px;border:1px solid #e6eef8" /></label><label>Email <input id="dlg_email" value="${u.email}" style="width:100%;padding:8px;border-radius:8px;border:1px solid #e6eef8" /></label><label>Ativo <select id="dlg_active"><option value="1" ${u.active?'selected':''}>Sim</option><option value="0" ${!u.active?'selected':''}>Não</option></select></label><div style="display:flex;gap:8px"><button class="btn" onclick="saveUser(${u.id})">Salvar</button><button onclick="closeDialog()" style="padding:8px;border-radius:8px;border:1px solid #e6eef8;background:white">Cancelar</button></div></div>`;
      showDialog('Editar Usuário', html);
    }
    function saveUser(id) {
      const u = MOCK.users.find(x=>x.id===id);
      if(!u) return;
      u.name = document.getElementById('dlg_name').value;
      u.email = document.getElementById('dlg_email').value;
      u.active = document.getElementById('dlg_active').value === '1';
      closeDialog();
      renderUsers();
    }

    function exportCSVAdmin() {
      const map = {};
      MOCK.bookings.forEach(b => {
        if(!map[b.service]) map[b.service] = {q:0,revenue:0};
        map[b.service].q++; map[b.service].revenue += b.price||0;
      });
      const rows=[['Serviço','QTD','Receita','Taxa']];
      Object.keys(map).forEach(k=>rows.push([k,map[k].q,map[k].revenue.toFixed(2),(map[k].revenue*(Settings.feePercent/100)).toFixed(2)]));
      const csv = rows.map(r=>r.map(c=>`"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
      const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'}); const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='report.csv'; a.click(); URL.revokeObjectURL(url);
    }

    function exportCSV() { exportCSVAdmin(); }

    function exportState() {
      const state = { MOCK, Settings };
      const blob = new Blob([JSON.stringify(state)], {type:'application/json'});
      const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='sim_state.json'; a.click(); URL.revokeObjectURL(url);
    }

    function randomizeData() {
      for(let i=0;i<4;i++){
        const t = MOCK.teachers[rand(0,MOCK.teachers.length-1)];
        const parent = MOCK.users.find(u=>u.type==='PARENT') || {name:'Pai Simulado', id:1};
        const d = new Date(); d.setDate(d.getDate()+rand(-3,3)); d.setHours(rand(8,18),0,0,0);
        MOCK.bookings.push({ id: 700 + MOCK.bookings.length + 1, parent: parent.name, parentId: parent.id, teacher: t.name, teacherId: t.id, service: t.services[0], datetime: d.toISOString(), status: ['CONFIRMED','COMPLETED'][rand(0,1)], price: parseFloat(t.hourly) + rand(0,40) });
      }
      refreshViews();
    }

    function refreshViews() {
      // update current view depending on role
      if(Settings.role === 'admin') { renderAdminDashboard(); renderBookings(); renderUsers(); }
      else if(Settings.role === 'teacher') renderTeacherDashboard();
      else if(Settings.role === 'parent') renderParentDashboard();
    }

    // helpers
    function formatDateIso(iso) { const d = new Date(iso); return d.toLocaleString('pt-BR'); }
    function sameDay(a,b) { return a.getDate()===b.getDate() && a.getMonth()===b.getMonth() && a.getFullYear()===b.getFullYear(); }

    // settings save & reset
    function saveSettings(){
      const fee = parseFloat(document.getElementById('cfgFee').value || '10');
      const interval = parseInt(document.getElementById('cfgInterval').value || '20');
      Settings.feePercent = fee; Settings.updateInterval = interval;
      saveSettingsToLocal();
      alert('Configurações salvas (simulado)');
      renderReports();
      renderAdminDashboard();
    }
    function resetData() {
      seedMockData(); saveSettingsToLocal(); refreshViews(); alert('Dados simulados resetados');
    }

    // routing on hash change
    window.addEventListener('hashchange', function() {
      // Garante que a navbar só aparece na home (sem hash)
      const isHome = !location.hash || location.hash === '';
      toggleNavbar(isHome);
      // Sempre chama a função de roteamento
      route();
    });

    document.getElementById('btnQuickSearch').addEventListener('click', ()=> {
      const q = document.getElementById('globalSearch').value.toLowerCase().trim();
      if(!q) return alert('Digite algo para pesquisar');
      // choose route depending on role
      if(Settings.role === 'admin') { location.hash = '#/admin/teachers'; setTimeout(()=>{ document.getElementById('filterService').value = q; renderTeachers('admin'); },100); }
      if(Settings.role === 'teacher') { location.hash = '#/teacher/lessons'; }
      if(Settings.role === 'parent') { location.hash = '#/parent/search'; setTimeout(()=>{ document.getElementById('p-search').value = q; renderParentSearch(); },100); }
    });

    // initial boot
    (function init(){
      seedMockData();
      document.getElementById('cfgFee').value = Settings.feePercent;
      document.getElementById('cfgInterval').value = Settings.updateInterval;
      // if developer wants to auto-enter admin for testing: uncomment below
      // enterRole('admin');
      // otherwise show home
    })();

    // Oculta navbar nas telas internas
    function toggleNavbar(show) {
      document.getElementById('main-navbar').style.display = show ? 'flex' : 'none';
      document.getElementById('navbar-space').style.display = show ? 'block' : 'none';
      // atualiza visibilidade do botão de instalação quando o estado muda
      try{ if(typeof updateInstallButtonVisibility === 'function') updateInstallButtonVisibility(); }catch(e){/*ignore*/}
    }
    
    // Mobile menu toggle (slide-in panel)
    function toggleMobileMenu(open){
      const panel = document.getElementById('mobile-menu');
      const overlay = document.getElementById('mobile-menu-overlay');
      if(!panel || !overlay) return;
      if(open){
        panel.classList.add('open'); overlay.classList.add('open'); document.body.style.overflow = 'hidden';
      } else {
        panel.classList.remove('open'); overlay.classList.remove('open'); document.body.style.overflow = '';
      }
    }

    // wire mobile menu button and overlay
    try{
      const mmBtn = document.getElementById('mobile-menu-btn');
      const mmOverlay = document.getElementById('mobile-menu-overlay');
      if(mmBtn) mmBtn.addEventListener('click', ()=> toggleMobileMenu(true));
      if(mmOverlay) mmOverlay.addEventListener('click', ()=> toggleMobileMenu(false));
    }catch(e){console.warn('mobile menu listeners failed', e)}
    
    // PWA install flow
    let deferredPrompt = null;
    const btnInstall = document.getElementById('btnInstall');
    window.addEventListener('beforeinstallprompt', (e) => {
      console.log('beforeinstallprompt event fired', e);
      e.preventDefault();
      deferredPrompt = e;
      // show install button on home
      if(document.getElementById('home-screen') && document.getElementById('home-screen').style.display !== 'none') {
        console.log('Showing install button (home visible)');
        btnInstall.style.display = 'inline-block';
      } else {
        console.log('Install prompt available but home not visible');
      }
    });
    
    // When home is shown, show/hide install button accordingly
    function updateInstallButtonVisibility() {
      const isHome = !location.hash || location.hash === '';
      const isAndroid = /Android/i.test(navigator.userAgent || '');
      // Show install button if we have the deferredPrompt OR as a fallback on Android browsers
      if(deferredPrompt) {
        btnInstall.style.display = isHome ? 'inline-block' : 'none';
        return;
      }
      // fallback: show a helpful install button on Android that opens instructions
      if(isAndroid && isHome) {
        btnInstall.style.display = 'inline-block';
        btnInstall.dataset.fallback = '1';
        return;
      }
      btnInstall.style.display = 'none';
    }
    
    // click handler to prompt installation
    btnInstall.addEventListener('click', async () => {
      // If we have the install prompt event available, use it (Chrome standard)
      if(deferredPrompt) {
        console.log('Triggering PWA prompt');
        deferredPrompt.prompt();
        const choice = await deferredPrompt.userChoice;
        console.log('User choice', choice);
        // hide after choice
        btnInstall.style.display = 'none';
        deferredPrompt = null;
        return;
      }
      // Fallback for Android browsers: show quick instructions to the user
      if(btnInstall.dataset && btnInstall.dataset.fallback === '1') {
        showInstallInstructions();
        return;
      }
      console.log('No deferredPrompt available and not on Android fallback');
    });

    // Show a simple dialog with steps to add to home screen (fallback)
    function showInstallInstructions(){
      const html = `<div style="max-width:360px"><p>Se o seu navegador não exibiu o pedido automático, você pode instalar manualmente usando o menu do Chrome:</p><ol><li>Abrir o menu (⋮) no canto superior direito do Chrome.</li><li>Selecionar "Adicionar à tela inicial" (ou "Add to Home screen").</li><li>Confirmar o nome e tocar em "Adicionar".</li></ol><p>Se quiser, atualize a página e tente novamente.</p><div style="margin-top:12px"><button class="btn" onclick="closeDialog()">Fechar</button></div></div>`;
      showDialog('Instalar App — instruções', html);
    }

    // register service worker
    if('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js').then(reg=>console.log('SW registered', reg)).catch(err => console.warn('SW register failed', err));
      });
    }
    // Exibe navbar apenas na home
    document.getElementById('home-screen').style.display = 'block';
    toggleNavbar(true);
    // Ao entrar em qualquer role, oculta navbar
    const oldEnterRole = enterRole;
    enterRole = function(role) {
      toggleNavbar(false);
      oldEnterRole(role);
    };
    // Ao voltar para home, exibe navbar
    document.getElementById('btnBackHome').onclick = () => {
      document.getElementById('app-shell').style.display = 'none';
      document.getElementById('home-screen').style.display = 'block';
      Settings.role = null;
      location.hash = '';
      toggleNavbar(true);
    };
  </script>
</body>
</html>
